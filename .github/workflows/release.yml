# GitHub Actions workflow for automated LanMount releases
#
# This workflow supports three build modes:
# 1. Full signed + notarized (default): Code signed and notarized by Apple
# 2. Signed only: Code signed but skip notarization (skip_notarization=true)
# 3. Unsigned: No signing or notarization (skip_signing=true) - anyone can install
#
# Build Process:
# - Signed builds use Fastlane for building, signing, and notarization
# - Unsigned builds use xcodebuild directly without any code signing
# - All builds create a DMG installer
# - All builds create a GitHub Release with the DMG attached
#
# Triggers:
# - Manual dispatch with version input and build options
# - Push of version tags (v*) - defaults to full signed + notarized
#
# Required Secrets (only for signed builds):
# - APPLE_DEVELOPER_CERTIFICATE_P12_BASE64: Base64-encoded .p12 certificate
# - APPLE_DEVELOPER_CERTIFICATE_PASSWORD: Password for the .p12 certificate
# - APPLE_ID: Apple ID email for notarization
# - APPLE_TEAM_ID: Apple Developer Team ID (10-character string)
# - APPLE_APP_SPECIFIC_PASSWORD: App-specific password for notarization
#
# Quick Start for Unsigned Builds:
# 1. Go to Actions tab
# 2. Select "Release" workflow
# 3. Click "Run workflow"
# 4. Enter version (e.g., 1.0.0)
# 5. Check "Skip code signing and notarization"
# 6. Click "Run workflow"
#
# Last updated: 2026-02-01

name: Release

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      skip_signing:
        description: 'Skip code signing and notarization (unsigned DMG)'
        required: false
        type: boolean
        default: false
      skip_notarization:
        description: 'Skip notarization only (signed but not notarized)'
        required: false
        type: boolean
        default: false

  # Trigger on version tags
  push:
    tags:
      - 'v*'

# Ensure only one release workflow runs at a time
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: LanMount
  XCODE_VERSION: '15.0'

jobs:
  # ==========================================================================
  # Build and Release Job
  # ==========================================================================
  build-and-release:
    name: Build, Sign, Notarize, and Release
    runs-on: macos-14  # macOS Sonoma with Apple Silicon
    
    steps:
      # ----------------------------------------------------------------------
      # Setup
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
          xcodebuild -version

      # ----------------------------------------------------------------------
      # Install Fastlane (only for signed builds)
      # ----------------------------------------------------------------------
      - name: Setup Ruby
        if: github.event.inputs.skip_signing != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install Fastlane dependencies
        if: github.event.inputs.skip_signing != 'true'
        run: |
          # Remove Gemfile.lock to avoid bundler version conflicts
          rm -f Gemfile.lock
          
          # Install latest bundler
          gem install bundler
          
          # Configure bundle
          bundle config set --local path 'vendor/bundle'
          
          # Install dependencies
          bundle install --jobs 4 --retry 3
          
          # Verify installation
          bundle exec fastlane --version

      # ----------------------------------------------------------------------
      # Certificate Setup (skip if building unsigned)
      # ----------------------------------------------------------------------
      - name: Install Apple Developer Certificate
        if: github.event.inputs.skip_signing != 'true'
        env:
          CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
        run: |
          # Verify secrets are available
          if [ -z "$CERTIFICATE_P12_BASE64" ] || [ -z "$CERTIFICATE_PASSWORD" ]; then
            echo "Error: Certificate secrets are not configured"
            echo "Please set APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 and APPLE_DEVELOPER_CERTIFICATE_PASSWORD in GitHub Secrets"
            echo "Or use skip_signing=true to build unsigned DMG"
            exit 1
          fi
          
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo -n "$CERTIFICATE_P12_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          
          # Check if certificate file was created successfully
          if [ ! -f "$CERTIFICATE_PATH" ] || [ ! -s "$CERTIFICATE_PATH" ]; then
            echo "Error: Failed to decode certificate"
            exit 1
          fi
          
          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          # Set keychain as default
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "Certificate installed successfully"
          
          # Verify certificate
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      # ----------------------------------------------------------------------
      # Create .env file for Fastlane (skip if building unsigned)
      # ----------------------------------------------------------------------
      - name: Create Fastlane environment file
        if: github.event.inputs.skip_signing != 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          cat > .env << EOF
          APPLE_ID=$APPLE_ID
          TEAM_ID=$APPLE_TEAM_ID
          APP_SPECIFIC_PASSWORD=$APPLE_APP_SPECIFIC_PASSWORD
          CODE_SIGN_IDENTITY=Developer ID Application
          APP_NAME=LanMount
          BUNDLE_ID=com.lanmount.app
          EOF
          echo "Fastlane .env file created"

      # ----------------------------------------------------------------------
      # Build with Fastlane or direct build for unsigned
      # ----------------------------------------------------------------------
      - name: Build and package with Fastlane
        if: github.event.inputs.skip_signing != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ "${{ github.event.inputs.skip_notarization }}" = "true" ]; then
            echo "Building without notarization..."
            bundle exec fastlane release version:$VERSION skip_notarize:true
          else
            echo "Building with notarization..."
            bundle exec fastlane release version:$VERSION
          fi

      - name: Build unsigned DMG
        if: github.event.inputs.skip_signing == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Building unsigned DMG..."
          
          # Build the app without signing
          xcodebuild \
            -project LanMount.xcodeproj \
            -scheme LanMount \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build
          
          # Create build directory
          mkdir -p build
          
          # Find the built app
          APP_PATH="build/DerivedData/Build/Products/Release/${{ env.APP_NAME }}.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: App not found at $APP_PATH"
            exit 1
          fi
          
          # Create DMG using hdiutil
          DMG_PATH="build/${{ env.APP_NAME }}-$VERSION.dmg"
          TEMP_DMG="build/temp.dmg"
          VOLUME_NAME="${{ env.APP_NAME }}"
          
          # Create temporary DMG
          hdiutil create -size 200m -fs HFS+ -volname "$VOLUME_NAME" "$TEMP_DMG"
          
          # Mount it
          MOUNT_DIR=$(hdiutil attach "$TEMP_DMG" | grep Volumes | awk '{print $3}')
          
          # Copy app to DMG
          cp -R "$APP_PATH" "$MOUNT_DIR/"
          
          # Create Applications symlink
          ln -s /Applications "$MOUNT_DIR/Applications"
          
          # Unmount
          hdiutil detach "$MOUNT_DIR"
          
          # Convert to compressed DMG
          hdiutil convert "$TEMP_DMG" -format UDZO -o "$DMG_PATH"
          
          # Cleanup
          rm "$TEMP_DMG"
          
          echo "Unsigned DMG created at $DMG_PATH"
          ls -lh "$DMG_PATH"

      - name: Verify build output
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check in both possible locations
          if [ "${{ github.event.inputs.skip_signing }}" = "true" ]; then
            DMG_PATH="build/${{ env.APP_NAME }}-$VERSION.dmg"
          else
            DMG_PATH="LanMount/build/${{ env.APP_NAME }}-$VERSION.dmg"
          fi
          
          if [ ! -f "$DMG_PATH" ]; then
            echo "Error: DMG not found at $DMG_PATH"
            exit 1
          fi
          
          echo "DMG created successfully at $DMG_PATH"
          ls -lh "$DMG_PATH"

      # ----------------------------------------------------------------------
      # Calculate DMG SHA256
      # ----------------------------------------------------------------------
      - name: Calculate DMG SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check in both possible locations
          if [ "${{ github.event.inputs.skip_signing }}" = "true" ]; then
            DMG_PATH="build/${{ env.APP_NAME }}-$VERSION.dmg"
          else
            DMG_PATH="LanMount/build/${{ env.APP_NAME }}-$VERSION.dmg"
          fi
          
          SHA256=$(shasum -a 256 "$DMG_PATH" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      # ----------------------------------------------------------------------
      # Generate Release Notes
      # ----------------------------------------------------------------------
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SKIP_SIGNING="${{ github.event.inputs.skip_signing == 'true' }}"
          NOTARIZED="${{ github.event.inputs.skip_notarization != 'true' && github.event.inputs.skip_signing != 'true' }}"
          
          # Create release notes
          cat > release_notes.md << EOF
          ## LanMount v$VERSION
          
          ### Downloads
          
          | Platform | Download |
          |----------|----------|
          | macOS (Universal) | [LanMount-$VERSION.dmg](https://github.com/${{ github.repository }}/releases/download/v$VERSION/LanMount-$VERSION.dmg) |
          
          ### System Requirements
          - macOS 12.0 (Monterey) or later
          - Apple Silicon (M1/M2/M3/M4) or Intel processor
          
          ### Security
          $(if [ "$SKIP_SIGNING" = "true" ]; then
            echo "- âš ï¸ **Unsigned build** - Not code signed or notarized"
            echo "- âš ï¸ This build can be installed by anyone without security verification"
            echo "- âš ï¸ macOS Gatekeeper will show warnings - Right-click and select 'Open' to bypass"
          else
            echo "- âœ… Code signed with Apple Developer ID"
            if [ "$NOTARIZED" = "true" ]; then
              echo "- âœ… Notarized by Apple"
            else
              echo "- âš ï¸ Not notarized (test build)"
            fi
            echo "- âœ… Hardened Runtime enabled"
          fi)
          
          ### Installation
          1. Download the DMG file below
          2. Open the DMG and drag LanMount to Applications folder
          3. Launch LanMount from Applications
          $(if [ "$SKIP_SIGNING" = "true" ]; then
            echo "4. **First launch:** Right-click the app and select 'Open' to bypass Gatekeeper"
            echo "5. Grant necessary permissions when prompted"
          else
            echo "4. Grant necessary permissions when prompted"
          fi)
          
          **SHA256:** \`${{ steps.sha256.outputs.sha256 }}\`
          
          ---
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/LanMount/CHANGELOG.md) for detailed changes.
          EOF
          
          echo "Release notes generated"
          cat release_notes.md

      # ----------------------------------------------------------------------
      # Create GitHub Release
      # ----------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: LanMount v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            ${{ github.event.inputs.skip_signing == 'true' && 'build' || 'LanMount/build' }}/${{ env.APP_NAME }}-${{ steps.version.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------------
      # Cleanup
      # ----------------------------------------------------------------------
      - name: Cleanup keychain and secrets
        if: always()
        run: |
          # Remove .env file
          rm -f .env
          
          # Remove keychain (only if it was created)
          if [ "${{ github.event.inputs.skip_signing }}" != "true" ]; then
            KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
            if [ -f "$KEYCHAIN_PATH" ]; then
              security delete-keychain "$KEYCHAIN_PATH" || true
            fi
          fi

      # ----------------------------------------------------------------------
      # Summary
      # ----------------------------------------------------------------------
      - name: Release Summary
        if: success()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SKIP_SIGNING="${{ github.event.inputs.skip_signing == 'true' }}"
          NOTARIZED="${{ github.event.inputs.skip_notarization != 'true' && github.event.inputs.skip_signing != 'true' }}"
          
          echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | v$VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA256 | \`${{ steps.sha256.outputs.sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Signed | $( [ "$SKIP_SIGNING" = "true" ] && echo "âŒ No" || echo "âœ… Yes" ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Notarized | $( [ "$NOTARIZED" = "true" ] && echo "âœ… Yes" || echo "âŒ No" ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ github.event.inputs.prerelease == 'true' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SKIP_SIGNING" = "true" ]; then
            echo "### âš ï¸ Unsigned Build" >> $GITHUB_STEP_SUMMARY
            echo "This is an unsigned build that can be installed by anyone without security verification." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ“¦ Download" >> $GITHUB_STEP_SUMMARY
          echo "- [LanMount-$VERSION.dmg](https://github.com/${{ github.repository }}/releases/download/v$VERSION/LanMount-$VERSION.dmg)" >> $GITHUB_STEP_SUMMARY

