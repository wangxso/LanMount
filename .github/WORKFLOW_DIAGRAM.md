# GitHub Actions Workflow 流程图

## 📊 完整发布流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         触发 Workflow                            │
├─────────────────────────────────────────────────────────────────┤
│  方法 1: 推送 Tag                                                │
│  $ git tag v1.0.0                                               │
│  $ git push origin v1.0.0                                       │
│                                                                  │
│  方法 2: 手动触发                                                │
│  GitHub Actions → Release → Run workflow                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      1. 环境准备                                 │
├─────────────────────────────────────────────────────────────────┤
│  ✓ Checkout 代码                                                │
│  ✓ 确定版本号                                                   │
│  ✓ 选择 Xcode 版本                                              │
│  ✓ 安装 Ruby 和 Bundler                                         │
│  ✓ 安装 Fastlane                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      2. 证书配置                                 │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 创建临时 Keychain                                            │
│  ✓ 解码 Base64 证书                                             │
│  ✓ 导入证书到 Keychain                                          │
│  ✓ 配置 Keychain 权限                                           │
│  ✓ 验证证书可用                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      3. 创建 .env 文件                           │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 从 GitHub Secrets 读取配置                                   │
│  ✓ 生成 Fastlane .env 文件                                      │
│  ✓ 包含 Apple ID、Team ID、密码                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   4. Fastlane 构建                               │
├─────────────────────────────────────────────────────────────────┤
│  $ bundle exec fastlane release version:1.0.0                   │
│                                                                  │
│  Fastlane 执行：                                                │
│  ├─ 更新版本号                                                  │
│  ├─ 构建应用 (xcodebuild)                                       │
│  ├─ 代码签名 (Developer ID)                                     │
│  ├─ 创建 DMG                                                    │
│  ├─ 提交公证 (notarytool)                                       │
│  ├─ 等待公证完成                                                │
│  ├─ 装订公证票据 (stapler)                                      │
│  └─ 验证公证                                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      5. 验证构建                                 │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 检查 DMG 文件存在                                            │
│  ✓ 计算 SHA256 校验和                                           │
│  ✓ 验证文件大小                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   6. 生成 Release Notes                          │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 创建 Markdown 格式的 Release Notes                           │
│  ✓ 包含下载链接                                                 │
│  ✓ 包含系统要求                                                 │
│  ✓ 包含安全信息                                                 │
│  ✓ 包含安装说明                                                 │
│  ✓ 包含 SHA256                                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   7. 创建 GitHub Release                         │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 创建 Release (v1.0.0)                                        │
│  ✓ 设置标题和描述                                               │
│  ✓ 上传 DMG 文件                                                │
│  ✓ 标记为正式版或预发布                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              8. 更新 Homebrew Cask (可选)                        │
├─────────────────────────────────────────────────────────────────┤
│  ✓ Clone Homebrew tap 仓库                                      │
│  ✓ 更新 version 和 sha256                                       │
│  ✓ Commit 并 push 更改                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      9. 清理和总结                               │
├─────────────────────────────────────────────────────────────────┤
│  ✓ 删除 .env 文件                                               │
│  ✓ 删除临时 Keychain                                            │
│  ✓ 生成构建摘要                                                 │
│  ✓ 显示下载链接                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                         ✅ 完成！                                │
├─────────────────────────────────────────────────────────────────┤
│  🎉 Release 已创建                                              │
│  📦 DMG 可供下载                                                │
│  🔐 已签名和公证                                                │
│  🍺 Homebrew 已更新（如果配置）                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 并行流程

某些步骤可以并行执行以提高速度：

```
┌──────────────┐
│  环境准备    │
└──────┬───────┘
       │
       ├─────────────┬─────────────┐
       ↓             ↓             ↓
┌──────────┐  ┌──────────┐  ┌──────────┐
│ 安装证书 │  │ 安装Ruby │  │ 创建.env │
└─────┬────┘  └─────┬────┘  └─────┬────┘
      └──────────┬──────────────┘
                 ↓
          ┌──────────┐
          │ Fastlane │
          │   构建   │
          └──────────┘
```

## ⏱️ 预计时间

| 步骤 | 时间 | 说明 |
|------|------|------|
| 环境准备 | 2-3 分钟 | 安装依赖 |
| 证书配置 | 10-20 秒 | 导入证书 |
| 构建应用 | 3-5 分钟 | 编译和签名 |
| 创建 DMG | 30-60 秒 | 打包 |
| 公证 | 10-30 分钟 | Apple 服务器处理 |
| 发布 | 1-2 分钟 | 创建 Release |
| **总计** | **15-40 分钟** | 取决于 Apple 公证速度 |

## 🎯 关键决策点

```
                    开始
                     ↓
              ┌─────────────┐
              │ 触发方式？  │
              └──────┬──────┘
                     │
        ┌────────────┼────────────┐
        ↓                         ↓
   ┌─────────┐              ┌─────────┐
   │ Tag推送 │              │ 手动触发│
   └────┬────┘              └────┬────┘
        │                        │
        │    ┌──────────────────┘
        │    │
        ↓    ↓
   ┌──────────────┐
   │ 跳过公证？   │
   └──────┬───────┘
          │
     ┌────┴────┐
     ↓         ↓
   ┌───┐    ┌───┐
   │是 │    │否 │
   └─┬─┘    └─┬─┘
     │        │
     │        ├─→ 提交公证
     │        │
     │        ├─→ 等待完成
     │        │
     │        └─→ 装订票据
     │
     └────────┼─→ 创建 Release
              │
              ↓
           ┌──────────────┐
           │ 预发布？     │
           └──────┬───────┘
                  │
             ┌────┴────┐
             ↓         ↓
          ┌────┐    ┌────┐
          │是  │    │否  │
          └─┬──┘    └─┬──┘
            │         │
            └────┬────┘
                 ↓
              完成
```

## 📊 成功率优化

为了提高 workflow 成功率：

1. **证书配置**
   - ✅ 使用正确的 Base64 编码
   - ✅ 确保证书未过期
   - ✅ 密码正确

2. **公证配置**
   - ✅ Team ID 是 10 位字符
   - ✅ App-specific password 有效
   - ✅ Apple ID 正确

3. **网络稳定性**
   - ✅ GitHub Actions 有稳定网络
   - ✅ 公证服务器可访问
   - ✅ 设置合理的超时时间

4. **错误处理**
   - ✅ 自动重试机制
   - ✅ 详细的错误日志
   - ✅ 清理临时文件

## 🔍 监控和调试

查看 workflow 执行：

1. **GitHub Actions 页面**
   - 访问仓库的 Actions 标签
   - 查看运行历史
   - 点击具体运行查看详情

2. **日志查看**
   - 展开每个步骤查看日志
   - 搜索错误信息
   - 下载完整日志

3. **构建摘要**
   - 每次运行后自动生成
   - 包含版本、SHA256、下载链接
   - 显示在 Summary 标签

---

**提示：** 首次运行建议跳过公证，快速验证构建流程是否正常。
