# Fastfile for LanMount
# è‡ªåŠ¨åŒ–æ„å»ºã€ç­¾åã€å…¬è¯å’Œå‘å¸ƒæµç¨‹

default_platform(:mac)

platform :mac do
  
  # é…ç½®å˜é‡
  APP_NAME = "LanMount"
  SCHEME = "LanMount"
  PROJECT = "LanMount.xcodeproj"
  BUNDLE_ID = "com.lanmount.app"
  
  # ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
  before_all do
    # ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨
    unless File.exist?("../.env")
      UI.user_error!("âŒ .env æ–‡ä»¶ä¸å­˜åœ¨ï¼è¯·å¤åˆ¶ .env.example å¹¶é…ç½®ã€‚")
    end
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    Dotenv.load("../.env")
    
    # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
    required_vars = ["APPLE_ID", "TEAM_ID", "APP_SPECIFIC_PASSWORD"]
    missing_vars = required_vars.select { |var| ENV[var].nil? || ENV[var].empty? }
    
    unless missing_vars.empty?
      UI.user_error!("âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: #{missing_vars.join(', ')}")
    end
    
    UI.success("âœ… ç¯å¢ƒå˜é‡åŠ è½½å®Œæˆ")
  end
  
  # ==========================================
  # Lane: å®Œæ•´å‘å¸ƒæµç¨‹
  # ==========================================
  desc "å®Œæ•´çš„å‘å¸ƒæµç¨‹ï¼šæ„å»ºã€ç­¾åã€å…¬è¯ã€åˆ›å»º DMG"
  lane :release do |options|
    version = options[:version] || prompt(text: "è¯·è¾“å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0): ")
    
    UI.header("ğŸš€ å¼€å§‹å‘å¸ƒ LanMount v#{version}")
    
    # 1. è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    unless options[:skip_tests]
      UI.message("ğŸ“ è¿è¡Œæµ‹è¯•...")
      begin
        run_tests(
          scheme: SCHEME,
          destination: "platform=macOS"
        )
        UI.success("âœ… æµ‹è¯•é€šè¿‡")
      rescue => ex
        UI.important("âš ï¸  æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º")
      end
    end
    
    # 2. æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰
    unless options[:skip_version_bump]
      UI.message("ğŸ“ æ›´æ–°ç‰ˆæœ¬å·...")
      update_version(version: version)
      update_build_number(build: Time.now.strftime("%Y%m%d%H%M"))
    end
    
    # 3. æ„å»ºåº”ç”¨
    build_app_release
    
    # 4. åˆ›å»º DMG
    dmg_path = create_dmg(version: version)
    
    # 5. å…¬è¯
    unless options[:skip_notarize]
      notarize_dmg(dmg_path: dmg_path)
    else
      UI.important("âš ï¸  è·³è¿‡å…¬è¯")
    end
    
    # 6. å®Œæˆ
    UI.success("ğŸ‰ å‘å¸ƒå®Œæˆï¼")
    UI.success("ğŸ“¦ DMG: #{dmg_path}")
  end
  
  # ==========================================
  # Lane: ä»…æ„å»ºåº”ç”¨
  # ==========================================
  desc "æ„å»º Release ç‰ˆæœ¬çš„åº”ç”¨"
  lane :build_app_release do
    UI.header("ğŸ”¨ æ„å»ºåº”ç”¨")
    
    # æ¸…ç†æ„å»ºç›®å½•
    sh("rm", "-rf", "../build")
    sh("mkdir", "-p", "../build/Release")
    
    # ä½¿ç”¨ xcodebuild ç›´æ¥æ„å»º
    Dir.chdir("..") do
      sh(
        "xcodebuild",
        "-scheme", SCHEME,
        "-project", PROJECT,
        "-configuration", "Release",
        "-derivedDataPath", "build/DerivedData",
        "clean", "build",
        "CODE_SIGN_IDENTITY="
      )
      
      # å¤åˆ¶ app åˆ°è¾“å‡ºç›®å½•
      app_source = "build/DerivedData/Build/Products/Release/#{APP_NAME}.app"
      app_dest = "build/Release/#{APP_NAME}.app"
      
      if File.exist?(app_source)
        sh("cp", "-R", app_source, app_dest)
        UI.success("âœ… åº”ç”¨å·²å¤åˆ¶åˆ°: #{app_dest}")
      else
        UI.user_error!("âŒ æ„å»ºçš„åº”ç”¨ä¸å­˜åœ¨: #{app_source}")
      end
    end
    
    UI.success("âœ… æ„å»ºå®Œæˆ")
  end
  
  # ==========================================
  # Lane: åˆ›å»º DMG
  # ==========================================
  desc "åˆ›å»º DMG å®‰è£…åŒ…"
  lane :create_dmg do |options|
    UI.header("ğŸ“¦ åˆ›å»º DMG")
    
    version = options[:version] || "1.0.0"
    app_path = "../build/Release/#{APP_NAME}.app"
    dmg_path = "../build/#{APP_NAME}-#{version}.dmg"
    
    # éªŒè¯åº”ç”¨å­˜åœ¨
    unless File.exist?(app_path)
      UI.user_error!("âŒ åº”ç”¨ä¸å­˜åœ¨: #{app_path}")
    end
    
    # åˆ é™¤æ—§çš„ DMG
    if File.exist?(dmg_path)
      UI.message("åˆ é™¤æ—§çš„ DMG...")
      sh("rm", "-f", dmg_path)
    end
    
    # ä½¿ç”¨ hdiutil åˆ›å»º DMG
    UI.message("åˆ›å»º DMG...")
    sh(
      "hdiutil",
      "create",
      "-volname", APP_NAME,
      "-srcfolder", app_path,
      "-ov",
      "-format", "UDZO",
      dmg_path
    )
    
    UI.success("âœ… DMG åˆ›å»ºå®Œæˆ: #{dmg_path}")
    dmg_path
  end
  
  # ==========================================
  # Lane: å…¬è¯ DMG
  # ==========================================
  desc "å…¬è¯ DMG æ–‡ä»¶"
  lane :notarize_dmg do |options|
    UI.header("ğŸ” å…¬è¯ DMG")
    
    dmg_path = options[:dmg_path]
    
    # è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    absolute_dmg_path = File.expand_path(dmg_path)
    
    unless File.exist?(absolute_dmg_path)
      UI.user_error!("âŒ DMG ä¸å­˜åœ¨: #{absolute_dmg_path}")
    end
    
    # ä½¿ç”¨ notarytool å…¬è¯
    UI.message("æäº¤å…¬è¯è¯·æ±‚...")
    UI.message("DMG è·¯å¾„: #{absolute_dmg_path}")
    
    # ä½¿ç”¨ xcrun notarytool ç›´æ¥å…¬è¯
    Dir.chdir("..") do
      sh(
        "xcrun",
        "notarytool",
        "submit",
        absolute_dmg_path,
        "--apple-id", ENV["APPLE_ID"],
        "--team-id", ENV["TEAM_ID"],
        "--password", ENV["APP_SPECIFIC_PASSWORD"],
        "--wait"
      )
    end
    
    # è£…è®¢å…¬è¯ç¥¨æ®
    UI.message("è£…è®¢å…¬è¯ç¥¨æ®...")
    sh("xcrun", "stapler", "staple", absolute_dmg_path)
    
    # éªŒè¯
    UI.message("éªŒè¯å…¬è¯...")
    sh("xcrun", "stapler", "validate", absolute_dmg_path)
    
    UI.success("âœ… å…¬è¯å®Œæˆ")
  end
  
  # ==========================================
  # Lane: ä»…å…¬è¯ï¼ˆç”¨äºå·²æœ‰çš„ DMGï¼‰
  # ==========================================
  desc "å…¬è¯å·²å­˜åœ¨çš„ DMG æ–‡ä»¶"
  lane :notarize_only do |options|
    dmg_path = options[:dmg]
    
    unless dmg_path
      UI.user_error!("âŒ è¯·æä¾› DMG è·¯å¾„: fastlane notarize_only dmg:path/to/file.dmg")
    end
    
    # è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    absolute_dmg_path = File.expand_path(dmg_path, "..")
    
    notarize_dmg(dmg_path: absolute_dmg_path)
  end
  
  # ==========================================
  # Lane: æµ‹è¯•æ„å»ºï¼ˆä¸å…¬è¯ï¼‰
  # ==========================================
  desc "æµ‹è¯•æ„å»ºï¼ˆè·³è¿‡å…¬è¯ï¼‰"
  lane :test_build do |options|
    version = options[:version] || "test"
    
    release(
      version: version,
      skip_tests: true,
      skip_notarize: true
    )
  end
  
  # ==========================================
  # Lane: æ¸…ç†æ„å»ºæ–‡ä»¶
  # ==========================================
  desc "æ¸…ç†æ„å»ºæ–‡ä»¶å’Œç¼“å­˜"
  lane :clean do
    UI.header("ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶")
    
    # æ¸…ç†æ„å»ºç›®å½•
    sh("rm", "-rf", "../build")
    
    # æ¸…ç† Xcode ç¼“å­˜
    sh("rm", "-rf", "~/Library/Developer/Xcode/DerivedData")
    
    # è¿è¡Œæ¸…ç†è„šæœ¬
    sh("../Scripts/cleanup-dmg.sh")
    
    UI.success("âœ… æ¸…ç†å®Œæˆ")
  end
  
  # ==========================================
  # Lane: éªŒè¯é…ç½®
  # ==========================================
  desc "éªŒè¯ Fastlane é…ç½®"
  lane :validate do
    UI.header("ğŸ” éªŒè¯é…ç½®")
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    UI.message("æ£€æŸ¥ç¯å¢ƒå˜é‡...")
    required_vars = ["APPLE_ID", "TEAM_ID", "APP_SPECIFIC_PASSWORD"]
    required_vars.each do |var|
      if ENV[var].nil? || ENV[var].empty?
        UI.error("âŒ ç¼ºå°‘: #{var}")
      else
        UI.success("âœ… #{var}: #{ENV[var][0..10]}...")
      end
    end
    
    # æ£€æŸ¥è¯ä¹¦
    UI.message("æ£€æŸ¥ä»£ç ç­¾åè¯ä¹¦...")
    begin
      sh("security", "find-identity", "-v", "-p", "codesigning")
      UI.success("âœ… æ‰¾åˆ°ä»£ç ç­¾åè¯ä¹¦")
    rescue
      UI.error("âŒ æœªæ‰¾åˆ°ä»£ç ç­¾åè¯ä¹¦")
    end
    
    # æ£€æŸ¥é¡¹ç›®æ–‡ä»¶
    UI.message("æ£€æŸ¥é¡¹ç›®æ–‡ä»¶...")
    if File.exist?("../#{PROJECT}")
      UI.success("âœ… é¡¹ç›®æ–‡ä»¶å­˜åœ¨")
    else
      UI.error("âŒ é¡¹ç›®æ–‡ä»¶ä¸å­˜åœ¨")
    end
    
    UI.success("âœ… éªŒè¯å®Œæˆ")
  end
  
  # ==========================================
  # é”™è¯¯å¤„ç†
  # ==========================================
  error do |lane, exception|
    UI.error("âŒ Lane #{lane} å¤±è´¥")
    UI.error("é”™è¯¯: #{exception.message}")
  end
  
  # ==========================================
  # è¾…åŠ©æ–¹æ³•
  # ==========================================
  
  # æ›´æ–°ç‰ˆæœ¬å·
  private_lane :update_version do |options|
    version = options[:version]
    
    Dir.chdir("..") do
      sh(
        "xcrun",
        "agvtool",
        "new-marketing-version",
        version
      )
    end
  end
  
  # æ›´æ–°æ„å»ºå·
  private_lane :update_build_number do |options|
    build = options[:build]
    
    Dir.chdir("..") do
      sh(
        "xcrun",
        "agvtool",
        "new-version",
        "-all",
        build
      )
    end
  end
end
